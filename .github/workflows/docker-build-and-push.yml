name: Docker image build and push

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: write

env:
  ECR_SUFFIX: ".dkr.ecr.ca-central-1.amazonaws.com"
  STAGING_ACCOUNT_ID: "239043911459"
  PRODUCTION_ACCOUNT_ID: "296255494825"

jobs:
  docker-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - lambda: blazer
            image: database-tools/blazer
          - lambda: google-cidr
            image: lambda/google-cidr
          - lambda: heartbeat
            image: notify/heartbeat
          - lambda: system_status
            image: notify/system_status

    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # tag=v2.11.1
        id: changes
        with:
          filters: |
            lambda:
              - '${{ matrix.lambda }}/**'
              - '.github/workflows/docker-build-and-push.yml'

      - name: Build Docker image
        if: steps.changes.outputs.lambda == 'true'
        working-directory: ${{ matrix.lambda }}
        run: make docker

      # Staging image push
      - name: Staging AWS credentials
        if: steps.changes.outputs.lambda == 'true'
        uses: aws-actions/configure-aws-credentials@67fbcbb121271f7775d2e7715933280b06314838 # tag=v1.7.0
        with:
          role-to-assume: arn:aws:iam::${{ env.STAGING_ACCOUNT_ID }}:role/notification-lambdas-apply
          role-session-name: ECRPush
          aws-region: ca-central-1

      - name: Staging ECR login
        if: steps.changes.outputs.lambda == 'true'
        id: staging-ecr
        uses: aws-actions/amazon-ecr-login@5a88a04c91d5c6f97aae0d9be790e64d9b1d47b7 # v1.7.1

      - name: Staging ECR push
        if: steps.changes.outputs.lambda == 'true'
        run: |
          STAGING_ECR="${{ env.STAGING_ACCOUNT_ID }}${{ env.ECR_SUFFIX }}"
          docker tag ${{ matrix.image }} $STAGING_ECR/${{ matrix.image }}:$GITHUB_SHA
          docker tag ${{ matrix.image }} $STAGING_ECR/${{ matrix.image }}:latest
          docker push $STAGING_ECR/${{ matrix.image }}:$GITHUB_SHA
          docker push $STAGING_ECR/${{ matrix.image }}:latest

      - name: Staging ECR logout
        if: steps.changes.outputs.lambda == 'true'
        run: docker logout ${{ steps.staging-ecr.outputs.registry }}

      # Staging Lambda Restart
      - name: Deploy lambda
        run: |
          STAGING_ECR="${{ env.STAGING_ACCOUNT_ID }}${{ env.ECR_SUFFIX }}"
          aws lambda update-function-code \
            --function-name ${{ matrix.image }} \
            --image-uri $REGISTRY/${{ matrix.image }}:${GITHUB_SHA::7} > /dev/null 2>&1

      - name: Publish lambda version and update alias
        run: |
          aws lambda wait function-updated --function-name ${{ matrix.image }}
          VERSION="$(aws lambda publish-version --function-name ${{ matrix.image }} | jq -r '.Version')"
          aws lambda update-alias \
            --function-name ${{ matrix.image }} \
            --name latest \
            --function-version "$VERSION" > /dev/null 2>&1

      # Production image push
      - name: Production AWS credentials
        if: steps.changes.outputs.lambda == 'true'
        uses: aws-actions/configure-aws-credentials@67fbcbb121271f7775d2e7715933280b06314838 # tag=v1.7.0
        with:
          role-to-assume: arn:aws:iam::${{ env.PRODUCTION_ACCOUNT_ID }}:role/notification-lambdas-apply
          role-session-name: ECRPush
          aws-region: ca-central-1

      - name: Production ECR login
        if: steps.changes.outputs.lambda == 'true'
        id: production-ecr
        uses: aws-actions/amazon-ecr-login@5a88a04c91d5c6f97aae0d9be790e64d9b1d47b7 # v1.7.1

      - name: Production ECR push
        if: steps.changes.outputs.lambda == 'true'
        run: |
          PRODUCTION_ECR="${{ env.PRODUCTION_ACCOUNT_ID }}${{ env.ECR_SUFFIX }}"
          docker tag ${{ matrix.image }} $PRODUCTION_ECR/${{ matrix.image }}:$GITHUB_SHA
          docker tag ${{ matrix.image }} $PRODUCTION_ECR/${{ matrix.image }}:latest
          docker push $PRODUCTION_ECR/${{ matrix.image }}:$GITHUB_SHA
          docker push $PRODUCTION_ECR/${{ matrix.image }}:latest

      - name: Generate docker SBOM
        if: steps.changes.outputs.lambda == 'true'
        uses: cds-snc/security-tools/.github/actions/generate-sbom@eecd7a02a0294b379411c126b61e5c29e253676a # v2.1.4
        with:
          docker_image: "${{ env.PRODUCTION_ACCOUNT_ID }}${{ env.ECR_SUFFIX }}/${{ matrix.image }}:latest"
          dockerfile_path: "${{ matrix.lambda }}/Dockerfile"
          sbom_name: "${{ matrix.lambda }}"
          token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Production ECR logout
        if: steps.changes.outputs.lambda == 'true'
        run: docker logout ${{ steps.production-ecr.outputs.registry }}

      - name: my-app-install token
        id: notify-pr-bot
        uses: getsentry/action-github-app-token@38a3ce582e170ddfe8789f509597c6944f2292a9 # v1.0.6
        with:
          app_id: ${{ secrets.NOTIFY_PR_BOT_APP_ID }}
          private_key: ${{ secrets.NOTIFY_PR_BOT_PRIVATE_KEY }}

      - uses: cds-snc/notification-pr-bot@main
        env:
          TOKEN: ${{ steps.notify-pr-bot.outputs.token }}